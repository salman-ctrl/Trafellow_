<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocaLab: Omni-Science Edition</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            black: '#050505',
                            dark: '#0a0f1c',
                            glass: 'rgba(20, 30, 50, 0.9)',
                            neonGreen: '#00ff41',
                            neonPink: '#ff00cc',
                            neonBlue: '#00f3ff',
                            warning: '#ff2a2a',
                            gold: '#ffd700',
                            purple: '#bd00ff'
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glitch': 'glitch 0.3s both infinite',
                        'drip': 'drip 0.5s infinite linear',
                        'flicker': 'flicker 0.1s infinite alternate',
                        'bubble': 'bubble 2s infinite linear',
                        'shard-fly': 'shard-fly 0.6s ease-out forwards',
                        'leak': 'leak 2s forwards'
                    },
                    keyframes: {
                        glitch: {
                            '0%': { transform: 'translate(0)' },
                            '20%': { transform: 'translate(-2px, 2px)' },
                            '40%': { transform: 'translate(-2px, -2px)' },
                            '60%': { transform: 'translate(2px, 2px)' },
                            '100%': { transform: 'translate(0)' }
                        },
                        drip: {
                            '0%': { transform: 'translateY(-10px)', opacity: 1 },
                            '100%': { transform: 'translateY(20px)', opacity: 0 }
                        },
                        flicker: {
                            '0%': { opacity: 0.8, transform: 'scaleY(1)' },
                            '100%': { opacity: 1, transform: 'scaleY(1.1) translateX(1px)' }
                        },
                        bubble: {
                            '0%': { bottom: '0%', opacity: 0 },
                            '50%': { opacity: 1 },
                            '100%': { bottom: '100%', opacity: 0 }
                        },
                        leak: {
                            '0%': { width: '0%', opacity: 0 },
                            '100%': { width: '120%', opacity: 0.8 }
                        },
                        'shard-fly': {
                            '0%': { transform: 'translate(0, 0) rotate(0deg)', opacity: 1 },
                            '100%': { transform: 'translate(var(--tx), var(--ty)) rotate(var(--tr))', opacity: 0 }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;700&display=swap');
        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #050505;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            color: #e2e8f0;
            overflow: hidden;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .glass-panel {
            background: rgba(16, 24, 39, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(0, 243, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        .crt-overlay {
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
        .flame-core {
            border-radius: 50% 50% 20% 20%;
            transform-origin: bottom center;
            filter: blur(5px);
        }
        .shard {
            position: absolute;
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.8);
            pointer-events: none;
        }
        .liquid { transition: height 0.3s ease, background-color 1s ease; }
        
        /* Custom Scrollbar for Inventory */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1a1a1a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #00f3ff; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const apiKey = ""; 

        // --- GEMINI HELPER ---
        const callGemini = async (prompt, systemInstruction) => {
            if (!apiKey) return "Error: API Key missing.";
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
            } catch (error) { return "Connection Error."; }
        };

        // --- VISUAL EFFECTS ---
        const Shards = () => {
            const shards = Array.from({ length: 8 }).map((_, i) => ({
                id: i,
                tx: `${(Math.random() - 0.5) * 100}px`, ty: `${(Math.random() * 50) + 20}px`, tr: `${Math.random() * 360}deg`,
                w: Math.random() * 10 + 5, h: Math.random() * 10 + 5, l: Math.random() * 100, t: Math.random() * 100
            }));
            return (
                <div className="absolute inset-0 overflow-visible pointer-events-none z-40">
                    {shards.map(s => (
                        <div key={s.id} className="shard animate-shard-fly" style={{ width: s.w, height: s.h, left: `${s.l}%`, top: `${s.t}%`, '--tx': s.tx, '--ty': s.ty, '--tr': s.tr }}></div>
                    ))}
                </div>
            );
        };

        const CracksOverlay = () => (
            <svg className="absolute inset-0 w-full h-full pointer-events-none z-30 opacity-90" viewBox="0 0 100 100" preserveAspectRatio="none">
                <path d="M50 0 L45 20 L55 30 L40 50 L60 60 L50 100" stroke="white" strokeWidth="0.5" fill="none" />
                <path d="M45 20 L20 25 M55 30 L80 35 M40 50 L10 55 M60 60 L90 55" stroke="white" strokeWidth="0.3" fill="none" />
            </svg>
        );

        // --- COMPONENTS ---

        const MissionSelect = ({ onSelect, onClose }) => (
            <div className="fixed inset-0 z-[100] bg-black/95 backdrop-blur-md flex items-center justify-center p-8 animate-fade-in">
                <div className="w-full max-w-6xl">
                    <div className="flex justify-between items-center mb-10 border-b border-gray-700 pb-6">
                        <div>
                            <h1 className="text-5xl font-bold text-white tracking-widest mb-2">VOCALAB <span className="text-cyber-neonBlue">HUB</span></h1>
                            <p className="text-gray-400 font-mono">SELECT SIMULATION MODULE</p>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-full transition-colors"><i data-lucide="x" className="w-8 h-8 text-white"></i></button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {[
                            { id: 'titration', title: 'TITRASI ASAM-BASA', icon: 'flask-conical', color: 'text-cyber-neonBlue', desc: 'Netralisasi HCl dengan NaOH. Latih presisi indikator warna & penanganan alat gelas.' },
                            { id: 'flame', title: 'UJI NYALA (FLAME TEST)', icon: 'flame', color: 'text-cyber-warning', desc: 'Identifikasi kation logam berdasarkan spektrum emisi warna api.' },
                            { id: 'electrolysis', title: 'ELEKTROLISIS', icon: 'zap', color: 'text-cyber-gold', desc: 'Reaksi redoks non-spontan dengan arus listrik. Pelapisan logam & produksi gas.' }
                        ].map(m => (
                            <div key={m.id} onClick={() => onSelect(m.id)} className="group bg-gray-900 border border-gray-700 hover:border-white rounded-2xl p-8 cursor-pointer transition-all hover:-translate-y-2 hover:shadow-2xl relative overflow-hidden">
                                <div className={`absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl from-${m.color.replace('text-', '')}/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity`}></div>
                                <div className={`w-20 h-20 rounded-xl bg-gray-800 flex items-center justify-center mb-6 group-hover:bg-gray-700 transition-colors`}>
                                    <i data-lucide={m.icon} className={`w-10 h-10 ${m.color}`}></i>
                                </div>
                                <h3 className="text-2xl font-bold text-white mb-3">{m.title}</h3>
                                <p className="text-gray-400 text-sm leading-relaxed">{m.desc}</p>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        const AIAssistant = ({ status, missionType, contextData, onAskAI }) => {
            const [query, setQuery] = useState("");
            const [isThinking, setIsThinking] = useState(false);
            const [response, setResponse] = useState(null);

            const getDefaultMsg = () => {
                if (status === 'danger') return "BAHAYA KRITIS! Evakuasi.";
                if (missionType === 'titration') return "Pantau pH dan perubahan warna indikator.";
                if (missionType === 'flame') return "Gunakan kawat bersih. Amati warna api.";
                if (missionType === 'electrolysis') return "Atur tegangan PSU. Amati elektroda.";
                return "Sistem Online.";
            };

            const handleAsk = async () => {
                if(!query.trim()) return;
                setIsThinking(true);
                const ans = await onAskAI(query, `Mission:${missionType}. Data:${JSON.stringify(contextData)}`);
                setResponse(ans);
                setIsThinking(false);
                setQuery("");
            };

            return (
                <div className="glass-panel p-3 rounded-xl flex flex-col gap-3 border-l-4 border-l-cyber-neonBlue h-64 mt-4 shrink-0">
                    <div className="flex items-start gap-3">
                        <div className={`w-10 h-10 shrink-0 rounded-full border-2 border-dashed flex items-center justify-center ${isThinking?'animate-spin':'animate-pulse'} border-cyber-neonBlue`}>
                            <i data-lucide="bot" className="w-5 h-5 text-cyber-neonBlue"></i>
                        </div>
                        <div className="flex-1 overflow-hidden flex flex-col h-full">
                            <h3 className="font-bold text-[10px] tracking-widest text-cyber-neonBlue uppercase mb-1">AI_PARTNER_V2</h3>
                            <div className="bg-black/30 p-2 rounded border border-white/5 flex-1 overflow-y-auto custom-scrollbar">
                                <p className="text-xs font-mono leading-tight text-gray-300">{response || getDefaultMsg()}</p>
                            </div>
                        </div>
                    </div>
                    <div className="pt-2 border-t border-white/10 flex gap-2">
                        <input value={query} onChange={e=>setQuery(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleAsk()} placeholder="Ask AI..." className="flex-1 bg-gray-900/50 border border-gray-700 rounded px-2 py-1 text-xs font-mono text-white focus:outline-none focus:border-cyber-neonBlue"/>
                        <button onClick={handleAsk} disabled={isThinking} className="bg-cyber-neonBlue/10 border border-cyber-neonBlue text-cyber-neonBlue px-2 rounded hover:bg-cyber-neonBlue/30"><i data-lucide="send" className="w-3 h-3"></i></button>
                    </div>
                </div>
            );
        };

        const ReportModal = ({ content, onClose }) => (
            <div className="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                <div className="glass-panel w-full max-w-2xl max-h-[80vh] flex flex-col rounded-xl border border-cyber-neonGreen">
                    <div className="p-4 border-b border-white/10 flex justify-between items-center">
                        <h2 className="text-cyber-neonGreen font-bold">GENERATED_REPORT.enc</h2>
                        <button onClick={onClose} className="text-gray-400 hover:text-white"><i data-lucide="x" className="w-6 h-6"></i></button>
                    </div>
                    <div className="p-6 overflow-y-auto font-mono text-sm text-gray-300 whitespace-pre-wrap">{content || "GENERATING..."}</div>
                </div>
            </div>
        );

        // --- SIMULATION MODULES ---

        // 1. TITRATION STATION (The Detailed One)
        const TitrationStation = ({ active, onUpdate, hazard }) => {
            const [vol, setVol] = useState(0); // NaOH added
            const [buretVol, setBuretVol] = useState(50); // Remaining in buret
            const [valve, setValve] = useState(false);
            const [isBroken, setIsBroken] = useState(false);
            const [isExploded, setIsExploded] = useState(false);
            const interval = useRef(null);

            useEffect(() => {
                if (hazard) { 
                    setValve(false); clearInterval(interval.current); 
                    // Randomly decide between break or explode for variety if hazard triggered externally
                    if(Math.random() > 0.5) setIsBroken(true); else setIsExploded(true);
                }
            }, [hazard]);

            useEffect(() => {
                const molAcid = 2.5; 
                const baseMol = vol * 0.1;
                const totalVol = 25 + vol;
                let newPh = 7;
                if (baseMol < acidMol) newPh = -Math.log10((acidMol - baseMol)/totalVol);
                else if (baseMol > acidMol) newPh = 14 + Math.log10((baseMol - acidMol)/totalVol);
                newPh = Math.max(0, Math.min(14, newPh));

                let color = 'rgba(200, 255, 200, 0.2)';
                if (newPh >= 8.2 && newPh < 10) color = 'rgba(255, 0, 204, 0.4)';
                else if (newPh >= 10) color = 'rgba(255, 0, 204, 0.9)';

                onUpdate({ ph: newPh.toFixed(2), vol: vol.toFixed(1), status: isBroken||isExploded?'FAILED':'ACTIVE' });
            }, [vol, isBroken, isExploded]);

            const toggleValve = () => {
                if (isBroken || isExploded) return;
                setValve(!valve);
                if (!valve) {
                    interval.current = setInterval(() => {
                        setVol(v => {
                            if(v >= 50) { clearInterval(interval.current); setValve(false); return 50; }
                            return v + 0.1;
                        });
                        setBuretVol(v => Math.max(0, v - 0.1));
                    }, 50);
                } else clearInterval(interval.current);
            };

            return (
                <div className="h-full flex gap-4">
                    {/* Inventory Panel (Restored) */}
                    <div className="w-1/4 flex flex-col gap-2 overflow-y-auto pr-2 border-r border-gray-700/50">
                        <h3 className="text-xs text-gray-400 font-bold mb-2">INVENTORY</h3>
                        <div className="p-3 bg-gray-800/50 border border-gray-600 rounded">
                            <div className="text-[10px] text-cyber-neonBlue">BURET</div>
                            <div className="font-bold text-white text-sm">NaOH 0.1M</div>
                            <div className="h-1 bg-gray-700 mt-1"><div className="h-full bg-cyber-neonBlue w-full"></div></div>
                        </div>
                        <div className="p-3 bg-gray-800/50 border border-gray-600 rounded">
                            <div className="text-[10px] text-cyber-neonGreen">FLASK</div>
                            <div className="font-bold text-white text-sm">HCl 0.1M</div>
                        </div>
                        <div className="p-3 bg-gray-800/50 border border-gray-600 rounded">
                            <div className="text-[10px] text-cyber-neonPink">INDICATOR</div>
                            <div className="font-bold text-white text-sm">Phenolphthalein</div>
                        </div>
                    </div>

                    {/* Simulation Area */}
                    <div className="flex-1 relative flex flex-col items-center justify-end pb-8">
                         {isExploded && <div className="absolute inset-0 z-40 bg-red-500/20 flex items-center justify-center animate-pulse"><h1 className="text-4xl font-black text-red-500 border-4 border-red-500 p-4 rotate-12 bg-black">EXPLOSION</h1></div>}
                        
                         {/* Buret */}
                        <div className={`w-8 h-64 border-x-2 border-white/20 bg-white/5 relative mb-1 transition-transform ${isBroken ? '-rotate-1' : ''}`}>
                            <div className="absolute bottom-0 w-full bg-cyber-neonBlue/60 transition-all" style={{ height: `${(buretVol/50)*100}%`, boxShadow: '0 0 10px #00f3ff' }}></div>
                            {/* Graduations */}
                            {[...Array(5)].map((_,i) => <div key={i} className="absolute right-0 h-[1px] w-2 bg-white/40" style={{top: `${i*20}%`}}></div>)}
                        </div>
                        
                        {/* Valve */}
                        <button onClick={toggleValve} className={`w-10 h-10 rounded-full border border-gray-500 mb-6 z-20 flex items-center justify-center transition-all hover:border-white ${valve ? 'bg-cyber-neonGreen rotate-90 shadow-[0_0_10px_#00ff41]' : 'bg-gray-800'}`}>
                            <i data-lucide="settings-2" className="w-5 h-5 text-white"></i>
                        </button>
                        
                        {/* Drops */}
                        {valve && <div className="absolute top-[300px] left-1/2 -translate-x-1/2 w-1 h-3 bg-cyber-neonBlue animate-drip rounded-full z-10"></div>}

                        {/* Erlenmeyer Flask (Detailed) */}
                        <div className={`relative w-40 h-52 transition-transform duration-200 ${isBroken ? 'rotate-6 translate-y-8 opacity-70' : ''}`}>
                            {isBroken && <Shards />}
                            <div className="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent backdrop-blur-md border border-white/20 z-20 rounded-b-3xl"
                                 style={{ clipPath: isBroken ? 'polygon(35% 0, 65% 0, 80% 40%, 60% 60%, 100% 100%, 0% 100%, 20% 60%, 10% 30%)' : 'polygon(35% 0, 65% 0, 100% 100%, 0% 100%)' }}>
                                {isBroken && <CracksOverlay />}
                                {!isBroken && <div className="absolute top-4 left-10 w-2 h-32 bg-white/10 rounded-full blur-[1px] rotate-2"></div>}
                            </div>
                            
                            {/* Liquid */}
                            <div className="absolute bottom-1 left-[10%] right-[10%] h-[90%] z-10 overflow-hidden" 
                                 style={{ clipPath: 'polygon(30% 0, 70% 0, 100% 100%, 0% 100%)' }}>
                                <div className={`w-full h-full liquid relative ${isBroken ? 'opacity-0 transition-opacity duration-1000' : ''}`}
                                     style={{ 
                                         backgroundColor: vol*0.1 >= 2.5 ? (vol*0.1 > 2.6 ? 'rgba(255,0,204,0.9)' : 'rgba(255,0,204,0.4)') : 'rgba(200,255,200,0.2)',
                                         height: `${((25+vol)/100)*100}%`,
                                         boxShadow: vol*0.1 >= 2.5 ? '0 0 20px #ff00cc inset' : '0 0 10px #00ff41 inset'
                                     }}>
                                     <div className="absolute top-0 w-full h-1 bg-white opacity-30"></div>
                                </div>
                            </div>
                        </div>

                        {/* Puddle (Spill) */}
                        {isBroken && <div className="absolute -bottom-4 w-64 h-8 bg-cyber-neonPink/50 blur-md animate-leak"></div>}
                    </div>
                </div>
            );
        };

        // 2. FLAME TEST STATION
        const FlameStation = ({ onUpdate, hazard }) => {
            const [selectedMetal, setSelectedMetal] = useState(null);
            const [wireStatus, setWireStatus] = useState('dirty');
            const [burnerOn, setBurnerOn] = useState(false);
            const [flameColor, setFlameColor] = useState('blue');

            useEffect(() => { if(hazard) { setBurnerOn(false); setFlameColor('blue'); } }, [hazard]);

            const metals = [
                { id: 'Na', name: 'Natrium', flame: 'yellow', color: 'bg-yellow-400' },
                { id: 'K', name: 'Kalium', flame: 'purple', color: 'bg-purple-500' },
                { id: 'Cu', name: 'Tembaga', flame: 'green', color: 'bg-green-500' },
                { id: 'Sr', name: 'Stronsium', flame: 'red', color: 'bg-red-500' }
            ];

            const handleAction = (type, data) => {
                if(type === 'clean') { setWireStatus('clean'); setFlameColor('blue'); }
                if(type === 'load' && wireStatus === 'clean') { setWireStatus('loaded'); setSelectedMetal(data); }
                if(type === 'burn' && wireStatus === 'loaded' && burnerOn) {
                    setFlameColor(data.flame);
                    onUpdate({ metal: data.name, color: data.flame });
                }
            };

            const getFlameStyle = () => {
                if(!burnerOn) return 'opacity-0';
                const colors = {
                    blue: 'bg-blue-500 shadow-[0_0_20px_#3b82f6]',
                    yellow: 'bg-yellow-400 shadow-[0_0_40px_#facc15]',
                    purple: 'bg-purple-500 shadow-[0_0_40px_#a855f7]',
                    green: 'bg-green-500 shadow-[0_0_40px_#22c55e]',
                    red: 'bg-red-600 shadow-[0_0_40px_#dc2626]'
                };
                return colors[flameColor] || colors.blue;
            };

            return (
                <div className="h-full flex gap-6">
                    {/* Controls */}
                    <div className="w-1/3 flex flex-col gap-4">
                         <div className="p-4 bg-gray-800/80 rounded-xl border border-gray-600">
                            <h3 className="text-xs text-gray-400 font-bold mb-3">1. PREPARATION</h3>
                            <button onClick={()=>handleAction('clean')} className="w-full py-3 bg-gray-700 hover:bg-gray-600 rounded text-xs text-white font-bold flex items-center justify-center gap-2">
                                <i data-lucide="droplet" className="w-4 h-4 text-cyber-neonBlue"></i> DIP IN HCl (STERILIZE)
                            </button>
                        </div>
                        <div className="p-4 bg-gray-800/80 rounded-xl border border-gray-600 flex-1">
                            <h3 className="text-xs text-gray-400 font-bold mb-3">2. SAMPLES</h3>
                            <div className="grid grid-cols-2 gap-3">
                                {metals.map(m => (
                                    <button key={m.id} onClick={()=>handleAction('load', m)} disabled={wireStatus!=='clean'} className={`p-3 rounded border font-bold text-xs flex flex-col items-center gap-2 transition-all ${wireStatus==='clean'?'border-gray-500 hover:border-white bg-gray-700':'opacity-30 border-transparent bg-black'}`}>
                                        <div className={`w-3 h-3 rounded-full ${m.color}`}></div>
                                        {m.name}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Stage */}
                    <div className="flex-1 bg-gray-900/40 rounded-xl border border-gray-700 relative flex flex-col items-center justify-end pb-12">
                        {/* Wire Tool */}
                        <div className={`absolute top-0 w-2 h-48 bg-gray-400 transition-all duration-500 origin-top z-20 ${wireStatus==='loaded' ? 'translate-y-24 rotate-0' : '-translate-y-full'}`} style={{left: '50%'}}>
                            <div className={`absolute bottom-0 -left-1 w-4 h-4 rounded-full border-2 border-gray-300 ${wireStatus==='loaded'?'bg-white':''}`}></div>
                        </div>

                        {/* Interactive Burn Zone */}
                        <div className="absolute inset-0 z-30 cursor-pointer" onClick={() => handleAction('burn', selectedMetal)}></div>

                        {/* Flame */}
                        <div className={`w-16 h-40 flame-core animate-flicker transition-all duration-300 ${getFlameStyle()}`}></div>
                        
                        {/* Burner */}
                        <div className="w-20 h-6 bg-gray-600 rounded-t-sm"></div>
                        <div className="w-28 h-8 bg-gray-800 rounded-lg flex items-center justify-center border-t border-gray-600">
                             <button onClick={()=>setBurnerOn(!burnerOn)} className={`w-20 h-4 rounded ${burnerOn?'bg-red-500':'bg-gray-600'}`}></button>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. ELECTROLYSIS STATION
        const ElectrolysisStation = ({ onUpdate, hazard }) => {
            const [volt, setVolt] = useState(0);
            const [active, setActive] = useState(false);
            const [sol, setSol] = useState('NaCl');

            useEffect(() => {
                if(hazard) { setActive(false); setVolt(0); }
                const status = active && volt > 1 ? 'REACTION ACTIVE' : 'IDLE';
                onUpdate({ voltage: volt, solution: sol, status });
            }, [volt, active, sol, hazard]);

            return (
                <div className="h-full flex flex-col gap-4">
                    {/* PSU */}
                    <div className="bg-gray-800 p-4 rounded-xl border border-gray-600 flex items-center justify-between shadow-lg z-20">
                        <div>
                            <div className="text-[10px] text-cyber-gold font-bold tracking-widest">DC POWER SUPPLY</div>
                            <div className="text-4xl font-mono text-red-500 font-bold tracking-tighter">{active ? volt.toFixed(1) : '0.0'} <span className="text-sm text-red-800">V</span></div>
                        </div>
                        <div className="flex items-center gap-6">
                            <input type="range" min="0" max="12" step="0.5" value={volt} onChange={e=>setVolt(parseFloat(e.target.value))} className="w-48 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-cyber-gold"/>
                            <button onClick={()=>setActive(!active)} className={`w-14 h-14 rounded-full border-4 flex items-center justify-center transition-all ${active?'border-red-500 text-red-500 shadow-[0_0_20px_red] bg-red-900/20':'border-gray-600 text-gray-600 bg-black'}`}>
                                <i data-lucide="power" className="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>

                    {/* Tank */}
                    <div className="flex-1 relative bg-gray-900/30 rounded-xl border border-gray-800 flex justify-center items-end pb-8">
                         {/* Wires */}
                        <div className="absolute top-0 left-1/3 w-1 h-12 bg-black"></div>
                        <div className="absolute top-0 right-1/3 w-1 h-12 bg-red-600"></div>

                        <div className="w-64 h-64 border-x-4 border-b-4 border-white/10 rounded-b-xl bg-white/5 backdrop-blur-sm relative overflow-hidden">
                             {/* Liquid */}
                            <div className={`absolute bottom-0 w-full h-4/5 transition-colors duration-1000 ${sol==='CuSO4'?'bg-blue-600/40':'bg-white/10'}`}>
                                 {/* Electrodes */}
                                <div className="absolute top-4 left-10 w-6 h-full bg-gray-400 rounded-b shadow-lg">
                                     {active && volt>1 && sol==='CuSO4' && <div className="absolute inset-0 bg-orange-500/60 transition-opacity duration-[5s]"></div>}
                                     {active && volt>1 && <div className="absolute inset-0 flex flex-col items-center pt-10">{[...Array(6)].map((_,i)=><div key={i} className="w-1 h-1 bg-white rounded-full animate-bubble" style={{animationDelay: i*0.4+'s'}}></div>)}</div>}
                                </div>
                                <div className="absolute top-4 right-10 w-6 h-full bg-gray-800 rounded-b shadow-lg">
                                     {active && volt>1 && <div className="absolute inset-0 flex flex-col items-center pt-10">{[...Array(8)].map((_,i)=><div key={i} className="w-2 h-2 bg-white/50 rounded-full animate-bubble" style={{animationDelay: i*0.2+'s'}}></div>)}</div>}
                                </div>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="absolute bottom-4 flex gap-4">
                             {['NaCl', 'CuSO4'].map(s => (
                                 <button key={s} onClick={()=>setSol(s)} className={`px-4 py-2 rounded-full border text-xs font-bold transition-all ${sol===s ? (s==='NaCl'?'bg-cyber-gold text-black border-cyber-gold':'bg-blue-500 text-white border-blue-500') : 'bg-black border-gray-600 text-gray-500'}`}>
                                     SOLUTION: {s}
                                 </button>
                             ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [mission, setMission] = useState('titration');
            const [showSelect, setShowSelect] = useState(true);
            const [data, setData] = useState({});
            const [hazard, setHazard] = useState(false);
            const [report, setReport] = useState({ show: false, content: '', loading: false });

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            const triggerHazard = () => { setHazard(true); setTimeout(() => setHazard(false), 2000); };
            
            const handleAI = async (q, ctx) => callGemini(q, `Role: VocaBot. Context:${ctx}. Style: Cyberpunk, Short, Indonesian.`);
            
            const genReport = async () => {
                setReport({ show: true, loading: true, content: '' });
                const res = await callGemini("Buat laporan", `Mission:${mission}. Data:${JSON.stringify(data)}. Format: Markdown.`);
                setReport({ show: true, loading: false, content: res });
            };

            return (
                <div className="w-full h-screen bg-black text-white flex flex-col p-4 relative overflow-hidden">
                    <div className="absolute inset-0 crt-overlay z-50 pointer-events-none"></div>
                    
                    {showSelect && <MissionSelect onSelect={m => { setMission(m); setShowSelect(false); }} onClose={() => setShowSelect(false)} />}
                    {report.show && <ReportModal content={report.content} onClose={() => setReport({ ...report, show: false })} />}
                    
                    {hazard && <div className="absolute inset-0 z-[60] pointer-events-none bg-red-600/10 flex items-center justify-center"><h1 className="text-6xl font-black text-red-500 bg-black border-4 border-red-500 p-8 rotate-12 animate-pulse">HAZARD TRIGGERED</h1></div>}

                    {/* Header */}
                    <header className="flex justify-between items-center mb-4 z-20 shrink-0">
                        <div className="flex items-center gap-4">
                            <button onClick={() => setShowSelect(true)} className="w-10 h-10 bg-gray-800 hover:bg-cyber-neonBlue hover:text-black rounded flex items-center justify-center transition-all">
                                <i data-lucide="grid" className="w-5 h-5"></i>
                            </button>
                            <div>
                                <h1 className="text-xl font-bold tracking-widest">VOCALAB <span className="text-cyber-neonBlue text-sm">/// {mission.toUpperCase()}</span></h1>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={genReport} className="px-4 py-1 border border-cyber-purple text-cyber-purple hover:bg-cyber-purple hover:text-white rounded text-xs font-bold flex items-center gap-2"><i data-lucide="file-text" className="w-3 h-3"></i> REPORT</button>
                            <button onClick={triggerHazard} className="px-4 py-1 border border-red-500 text-red-500 hover:bg-red-500 hover:text-white rounded text-xs font-bold">[!] HAZARD</button>
                        </div>
                    </header>

                    {/* Main Layout */}
                    <div className="flex-1 grid grid-cols-12 gap-6 min-h-0">
                        {/* Sidebar */}
                        <div className="col-span-3 flex flex-col gap-4">
                            <div className="glass-panel p-4 rounded-xl">
                                <h2 className="text-gray-400 text-xs font-bold mb-2 flex items-center gap-2"><i data-lucide="activity" className="w-3 h-3"></i> METRICS</h2>
                                <div className="space-y-1 font-mono text-sm">
                                    {Object.entries(data).map(([k,v]) => (
                                        <div key={k} className="flex justify-between border-b border-gray-700/50 pb-1">
                                            <span className="text-gray-500 uppercase">{k}</span><span className="text-cyber-neonBlue">{v}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <AIAssistant status={hazard ? 'danger' : 'normal'} missionType={mission} contextData={data} onAskAI={handleAI} />
                        </div>

                        {/* Viewport */}
                        <div className="col-span-9 bg-gray-900/20 border border-gray-800 rounded-2xl p-6 relative overflow-hidden">
                            <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'radial-gradient(#3b82f6 1px, transparent 1px)', backgroundSize: '20px 20px'}}></div>
                            {mission === 'titration' && <TitrationStation active={!showSelect} onUpdate={setData} hazard={hazard} />}
                            {mission === 'flame' && <FlameStation onUpdate={setData} hazard={hazard} />}
                            {mission === 'electrolysis' && <ElectrolysisStation onUpdate={setData} hazard={hazard} />}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>